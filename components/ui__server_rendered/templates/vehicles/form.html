{% extends "layout.html" %}

{% block content %}
<div class="w-full" x-data='vehicleForm("{{ values.office_uuid|default("") }}", {{ office_selected|tojson }}, "{{ values.lat }}", "{{ values.lng }}", "{{ lang }}")'>
  <h1 class="text-2xl font-bold mb-6">{{ title }}</h1>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 items-start">
    <form method="post" action="{{ url_with_lang(form_action, lang=lang) if url_with_lang is defined and lang is defined else form_action }}" class="bg-white border border-slate-200 rounded-lg p-6 space-y-4">
      <div>
        <label for="office-search" class="block text-sm font-medium mb-1">{{ t(lang, "vehicles.office") }}</label>
        <input type="hidden" name="office_uuid" :value="officeUuid" />
        <div class="relative">
          <input
            id="office-search"
            type="text"
            x-model="officeSearch"
            @focus="openOfficeDropdown()"
            @input.debounce.350ms="onOfficeSearchChanged()"
            @keydown.arrow-down.prevent="highlightNextOffice()"
            @keydown.arrow-up.prevent="highlightPreviousOffice()"
            @keydown.enter.prevent="selectHighlightedOffice()"
            @keydown.escape.prevent="closeOfficeDropdown()"
            @click.away="closeOfficeDropdown()"
            :aria-expanded="officeDropdownOpen"
            aria-haspopup="listbox"
            aria-controls="office-options-list"
            placeholder="{{ t(lang, 'vehicles.search_office_placeholder') }}"
            class="w-full rounded-md border border-slate-300 px-3 py-2"
            {% if mode == 'view' %}disabled{% endif %}
          />
          <div
            id="office-options-list"
            x-show="officeDropdownOpen"
            x-transition
            @scroll.passive="onOfficeDropdownScroll($event)"
            role="listbox"
            class="absolute z-20 mt-1 max-h-64 w-full overflow-y-auto rounded-md border border-slate-200 bg-white shadow-lg"
            style="display: none;"
          >
            <template x-for="(office, index) in officeOptions" :key="office.uuid">
              <button
                type="button"
                role="option"
                :aria-selected="office.uuid === officeUuid"
                @mouseenter="highlightedOfficeIndex = index"
                @click="selectOffice(office)"
                class="block w-full px-3 py-2 text-left text-sm hover:bg-slate-100"
                :class="{ 'bg-slate-100': index === highlightedOfficeIndex, 'font-medium text-slate-900': office.uuid === officeUuid }"
                x-text="office.name"
              ></button>
            </template>

            <p x-show="officeLoading" class="px-3 py-2 text-sm text-slate-500">{{ t(lang, "common.loading") if t is defined else "Loading..." }}</p>
            <p x-show="officeError" class="px-3 py-2 text-sm text-red-700" x-text="officeError"></p>
            <p x-show="!officeLoading && !officeError && officeOptions.length === 0" class="px-3 py-2 text-sm text-slate-500">{{ t(lang, "common.no_results") if t is defined else "No results" }}</p>
          </div>
        </div>
        {% if errors.office_id %}<p class="text-sm text-red-700 mt-1">{{ errors.office_id }}</p>{% endif %}
      </div>

      <div>
        <label class="block text-sm font-medium mb-1">{{ t(lang, "vehicles.name") }}</label>
        <input type="text" name="name" value="{{ values.name }}" class="w-full rounded-md border border-slate-300 px-3 py-2" {% if mode == 'view' %}disabled{% endif %} />
        {% if errors.name %}<p class="text-sm text-red-700 mt-1">{{ errors.name }}</p>{% endif %}
      </div>

      <div>
        <label class="block text-sm font-medium mb-1">{{ t(lang, "vehicles.plate") }}</label>
        <input type="text" name="plate" value="{{ values.plate }}" class="w-full rounded-md border border-slate-300 px-3 py-2" {% if mode == 'view' %}disabled{% endif %} />
        {% if errors.plate %}<p class="text-sm text-red-700 mt-1">{{ errors.plate }}</p>{% endif %}
      </div>

      <div class="grid sm:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium mb-1">{{ t(lang, "offices.latitude") }}</label>
          <input type="number" step="any" name="lat" value="{{ values.lat }}" class="w-full rounded-md border border-slate-300 px-3 py-2" x-model="lat" @input.debounce.300ms="refreshMap()" {% if mode == 'view' %}disabled{% endif %} />
          {% if errors.lat %}<p class="text-sm text-red-700 mt-1">{{ errors.lat }}</p>{% endif %}
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">{{ t(lang, "offices.longitude") }}</label>
          <input type="number" step="any" name="lng" value="{{ values.lng }}" class="w-full rounded-md border border-slate-300 px-3 py-2" x-model="lng" @input.debounce.300ms="refreshMap()" {% if mode == 'view' %}disabled{% endif %} />
          {% if errors.lng %}<p class="text-sm text-red-700 mt-1">{{ errors.lng }}</p>{% endif %}
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium mb-1">{{ t(lang, "vehicles.max_capacity") }}</label>
        <input type="number" min="0" name="max_capacity" value="{{ values.max_capacity }}" class="w-full rounded-md border border-slate-300 px-3 py-2" {% if mode == 'view' %}disabled{% endif %} />
        {% if errors.max_capacity %}<p class="text-sm text-red-700 mt-1">{{ errors.max_capacity }}</p>{% endif %}
      </div>

      <div class="flex gap-3 pt-2">
        <a href="{{ url_with_lang('/vehicles', lang=lang) }}" class="px-4 py-2 border border-slate-300 rounded-md">{{ t(lang, "common.back") }}</a>
        {% if mode != 'view' %}
        <button type="submit" class="px-4 py-2 bg-slate-900 text-white rounded-md">{{ t(lang, "common.save") }}</button>
        {% endif %}
      </div>
    </form>

    <section class="bg-white border border-slate-200 rounded-lg p-3 lg:sticky lg:top-4">
      <h2 class="text-base font-semibold mb-3">{{ t(lang, "offices.map_location") }}</h2>
      <div class="aspect-[4/3] w-full overflow-hidden rounded-md border border-slate-200 bg-slate-50">
        <iframe title="Google map preview" class="h-full w-full" loading="lazy" referrerpolicy="no-referrer-when-downgrade" :src="mapUrl"></iframe>
      </div>
      <p class="text-xs text-slate-500 mt-2">{{ t(lang, "offices.showing_coordinates") }}: <span x-text="lat || '0'"></span>, <span x-text="lng || '0'"></span></p>
    </section>
  </div>
</div>

<script>
  function vehicleForm(initialOfficeUuid, initialOffice, initialLat, initialLng, lang) {
    return {
      officeUuid: initialOfficeUuid || "",
      officeSearch: initialOffice?.name || "",
      officeOptions: initialOffice ? [initialOffice] : [],
      officeDropdownOpen: false,
      officeLoading: false,
      officeError: "",
      highlightedOfficeIndex: 0,
      officeCurrentPage: 1,
      officeHasNextPage: true,
      officeRequestCounter: 0,
      officeLoadedForEmptySearch: false,
      officeLastSearch: "",
      lat: initialLat || "",
      lng: initialLng || "",
      mapUrl: "",

      init() {
        this.refreshMap();
      },

      openOfficeDropdown() {
        this.officeDropdownOpen = true;
        if (!this.officeLoadedForEmptySearch && !this.officeSearch.trim()) {
          this.fetchOffices({ reset: true });
          return;
        }
        if (!this.officeOptions.length) {
          this.fetchOffices({ reset: true });
        }
      },

      closeOfficeDropdown() {
        this.officeDropdownOpen = false;
      },

      onOfficeSearchChanged() {
        this.fetchOffices({ reset: true });
      },

      onOfficeDropdownScroll(event) {
        const el = event.target;
        const nearBottom = el.scrollTop + el.clientHeight >= el.scrollHeight - 40;
        if (nearBottom) {
          this.fetchOffices({ reset: false });
        }
      },

      async fetchOffices({ reset }) {
        if (this.officeLoading) return;
        if (!reset && !this.officeHasNextPage) return;

        const search = this.officeSearch.trim();
        if (reset) {
          this.officeCurrentPage = 1;
          this.officeHasNextPage = true;
          this.officeError = "";
          this.officeOptions = this.officeUuid && initialOffice ? [initialOffice] : [];
          this.highlightedOfficeIndex = 0;
        }

        this.officeLoading = true;
        const requestId = ++this.officeRequestCounter;
        const page = reset ? 1 : this.officeCurrentPage + 1;
        const params = new URLSearchParams({
          page: String(page),
          page_size: "20",
          search,
          sort: "name",
          order: "asc",
        });

        try {
          const response = await fetch(`/api/offices?${params.toString()}`);
          if (!response.ok) {
            throw new Error(lang === "es" ? "No se pudieron cargar oficinas" : "Could not load offices");
          }
          const body = await response.json();
          if (requestId !== this.officeRequestCounter) return;

          const incoming = (body.data || []).map((office) => ({ uuid: office.uuid, name: office.name }));
          const existingByUuid = new Map(this.officeOptions.map((item) => [item.uuid, item]));
          incoming.forEach((item) => existingByUuid.set(item.uuid, item));

          this.officeOptions = Array.from(existingByUuid.values()).sort((a, b) => a.name.localeCompare(b.name));
          this.officeCurrentPage = page;
          this.officeLastSearch = search;
          this.officeHasNextPage = Boolean(body.meta?.pagination?.hasNext);
          this.officeLoadedForEmptySearch = this.officeLoadedForEmptySearch || search.length === 0;

          if (this.officeUuid && !existingByUuid.has(this.officeUuid) && initialOffice?.uuid === this.officeUuid) {
            this.officeOptions.unshift(initialOffice);
          }

          if (!this.officeUuid && this.officeOptions.length > 0 && reset) {
            this.highlightedOfficeIndex = 0;
          }
        } catch (error) {
          if (requestId === this.officeRequestCounter) {
            this.officeError = error.message || (lang === "es" ? "Error al buscar oficinas" : "Error searching offices");
          }
        } finally {
          if (requestId === this.officeRequestCounter) {
            this.officeLoading = false;
          }
        }
      },

      selectOffice(office) {
        this.officeUuid = office.uuid;
        this.officeSearch = office.name;
        this.closeOfficeDropdown();
      },

      highlightNextOffice() {
        if (!this.officeDropdownOpen) this.openOfficeDropdown();
        if (!this.officeOptions.length) return;
        this.highlightedOfficeIndex = Math.min(this.highlightedOfficeIndex + 1, this.officeOptions.length - 1);
      },

      highlightPreviousOffice() {
        if (!this.officeDropdownOpen) this.openOfficeDropdown();
        if (!this.officeOptions.length) return;
        this.highlightedOfficeIndex = Math.max(this.highlightedOfficeIndex - 1, 0);
      },

      selectHighlightedOffice() {
        if (!this.officeDropdownOpen || !this.officeOptions.length) return;
        const office = this.officeOptions[this.highlightedOfficeIndex];
        if (office) {
          this.selectOffice(office);
        }
      },

      refreshMap() {
        const lat = this.lat && this.lat.trim() !== "" ? this.lat.trim() : "0";
        const lng = this.lng && this.lng.trim() !== "" ? this.lng.trim() : "0";
        this.mapUrl = `https://maps.google.com/maps?q=${encodeURIComponent(lat)},${encodeURIComponent(lng)}&z=15&output=embed`;
      },
    };
  }
</script>
{% endblock %}
