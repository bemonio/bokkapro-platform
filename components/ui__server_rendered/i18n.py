from urllib.parse import urlencode

SUPPORTED_LOCALES = {"en", "es"}
DEFAULT_LOCALE = "en"

TRANSLATIONS = {
    "en": {
        "common": {
            "app_name": "Bokkapro Platform",
            "back": "Back",
            "save": "Save",
            "actions": "Actions",
            "coming_soon": "Coming soon.",
            "language": "Language",
            "spanish": "Español",
            "english": "English",
            "loading": "Loading...",
            "no_results": "No results",
        },
        "menu": {
            "dashboard": "Dashboard",
            "offices": "Offices",
            "vehicles": "Vehicles",
            "crews": "Crews",
            "tasks": "Tasks",
            "routes": "Routes",
            "route_tasks": "Route Tasks",
        },
        "dashboard": {
            "title": "Dashboard",
            "manage_offices": "Manage office records.",
            "manage_vehicles": "Manage vehicle records.",
            "manage_tasks": "Manage operational tasks.",
            "manage_routes": "Manage planning routes.",
        },
        "vehicles": {
            "title": "Vehicles",
            "new_vehicle": "New Vehicle",
            "search_placeholder": "Search vehicles...",
            "name": "Name",
            "plate": "Plate",
            "office": "Office",
            "max_capacity": "Max Capacity",
            "view": "View",
            "edit": "Edit",
            "delete": "Delete",
            "delete_title": "Delete Vehicle",
            "delete_question": "Are you sure you want to delete {name}?",
            "delete_warning": "This action cannot be undone.",
            "cancel": "Cancel",
            "no_results": "No vehicles found.",
            "total": "Total",
            "prev": "Prev",
            "next": "Next",
            "page_of": "Page {page} / {total_pages}",
            "page_size": "{size} / page",
            "form_view_title": "Vehicle",
            "form_edit_title": "Edit Vehicle",
            "form_new_title": "New Vehicle",
            "select_office": "Select an office",
            "search_office_placeholder": "Search office...",
            "office_not_found": "Please select a valid office.",
        },
        "offices": {
            "title": "Offices",
            "new_office": "New Office",
            "search_placeholder": "Search offices...",
            "name": "Name",
            "address": "Address",
            "coordinates": "Coordinates",
            "storage": "Storage",
            "view": "View",
            "edit": "Edit",
            "delete": "Delete",
            "delete_title": "Delete Office",
            "delete_question": "Are you sure you want to delete {name}?",
            "delete_warning": "This action cannot be undone.",
            "cancel": "Cancel",
            "no_results": "No offices found.",
            "total": "Total",
            "prev": "Prev",
            "next": "Next",
            "page_of": "Page {page} / {total_pages}",
            "page_size": "{size} / page",
            "form_view_title": "Office",
            "form_edit_title": "Edit Office",
            "form_new_title": "New Office",
            "latitude": "Latitude",
            "longitude": "Longitude",
            "map_location": "Map location",
            "showing_coordinates": "Showing coordinates",
            "storage_capacity": "Storage Capacity",
            "name_required": "Name is required",
            "storage_required": "Storage capacity is required",
        },

        "routes": {
            "title": "Routes",
            "new_route": "New Route",
            "search_placeholder": "Search routes...",
            "office": "Office",
            "vehicle": "Vehicle",
            "service_date": "Service date",
            "status": "Status",
            "total_tasks": "Total tasks",
            "total_distance_m": "Total distance (m)",
            "total_duration_s": "Total duration (s)",
            "total_load": "Total load",
            "view": "View",
            "edit": "Edit",
            "delete": "Delete",
            "no_results": "No routes found.",
            "total": "Total",
            "prev": "Prev",
            "next": "Next",
            "page_of": "Page {page} / {total_pages}",
            "page_size": "{size} / page",
            "form_view_title": "Route",
            "form_edit_title": "Edit Route",
            "form_new_title": "New Route",
            "select_office": "Select an office",
            "search_office_placeholder": "Search office...",
            "office_load_error": "Unable to load offices. Please try again.",
            "select_vehicle": "Select a vehicle",
            "search_vehicle_placeholder": "Search vehicle...",
            "vehicle_load_error": "Unable to load vehicles. Please try again.",
            "status_draft": "Draft",
            "status_planned": "Planned",
            "status_in_progress": "In progress",
            "status_completed": "Completed",
            "status_cancelled": "Cancelled",
            "status_failed": "Failed"
        },

        "route_tasks": {
            "title": "Route Tasks",
            "new_route_task": "New Route Task",
            "search_placeholder": "Search route tasks...",
            "route_uuid": "Route",
            "task_uuid": "Task",
            "sequence_order": "Sequence",
            "status": "Status",
            "planned_arrival_at": "Planned arrival",
            "planned_departure_at": "Planned departure",
            "actual_arrival_at": "Actual arrival",
            "actual_departure_at": "Actual departure",
            "view": "View",
            "edit": "Edit",
            "delete": "Delete",
            "no_results": "No route tasks found.",
            "total": "Total",
            "prev": "Prev",
            "next": "Next",
            "page_of": "Page {page} / {total_pages}",
            "page_size": "{size} / page",
            "form_view_title": "Route Task",
            "form_edit_title": "Edit Route Task",
            "form_new_title": "New Route Task",
            "select_route": "Select a route",
            "search_route_placeholder": "Search route...",
            "route_load_error": "Unable to load routes. Please try again.",
            "select_task": "Select a task",
            "search_task_placeholder": "Search task...",
            "task_load_error": "Unable to load tasks. Please try again.",
            "status_pending": "Pending",
            "status_arrived": "Arrived",
            "status_completed": "Completed",
            "status_skipped": "Skipped",
            "status_failed": "Failed",
            "integrity_error": "Invalid route/task relation or duplicated sequence/task in route.",
        },
        "tasks": {
            "title": "Tasks",
            "new_task": "New Task",
            "search_placeholder": "Search tasks...",
            "type": "Type",
            "status": "Status",
            "office": "Office",
            "priority": "Priority",
            "reference": "Reference",
            "address": "Address",
            "time_window_start": "Time window start",
            "time_window_end": "Time window end",
            "service_duration_minutes": "Service duration (min)",
            "load_units": "Load units",
            "notes": "Notes",
            "view": "View",
            "edit": "Edit",
            "delete": "Delete",
            "delete_title": "Delete Task",
            "delete_question": "Are you sure you want to delete {name}?",
            "delete_warning": "This action cannot be undone.",
            "cancel": "Cancel",
            "no_results": "No tasks found.",
            "total": "Total",
            "prev": "Prev",
            "next": "Next",
            "page_of": "Page {page} / {total_pages}",
            "page_size": "{size} / page",
            "form_view_title": "Task",
            "form_edit_title": "Edit Task",
            "form_new_title": "New Task",
            "type_pickup": "Pickup",
            "type_delivery": "Delivery",
            "status_pending": "Pending",
            "status_scheduled": "Scheduled",
            "status_in_progress": "In progress",
            "status_completed": "Completed",
            "status_failed": "Failed",
            "status_cancelled": "Cancelled",
            "priority_low": "Low",
            "priority_normal": "Normal",
            "priority_high": "High",
            "select_office": "Select an office",
            "search_office_placeholder": "Search office...",
            "office_load_error": "Unable to load offices. Please try again.",
        },
    },
    "es": {
        "common": {
            "app_name": "Plataforma Bokkapro",
            "back": "Volver",
            "save": "Guardar",
            "actions": "Acciones",
            "coming_soon": "Próximamente.",
            "language": "Idioma",
            "spanish": "Español",
            "english": "Inglés",
            "loading": "Cargando...",
            "no_results": "Sin resultados",
        },
        "menu": {
            "dashboard": "Panel",
            "offices": "Oficinas",
            "vehicles": "Vehículos",
            "crews": "Cuadrillas",
            "tasks": "Tareas",
            "routes": "Rutas",
            "route_tasks": "Tareas de ruta",
        },
        "dashboard": {
            "title": "Panel",
            "manage_offices": "Gestiona los registros de oficinas.",
            "manage_vehicles": "Gestiona los registros de vehículos.",
            "manage_tasks": "Gestiona las tareas operativas.",
            "manage_routes": "Gestiona las rutas de planificación.",
        },
        "vehicles": {
            "title": "Vehículos",
            "new_vehicle": "Nuevo vehículo",
            "search_placeholder": "Buscar vehículos...",
            "name": "Nombre",
            "plate": "Placa",
            "office": "Oficina",
            "max_capacity": "Capacidad máxima",
            "view": "Ver",
            "edit": "Editar",
            "delete": "Eliminar",
            "delete_title": "Eliminar vehículo",
            "delete_question": "¿Seguro que quieres eliminar {name}?",
            "delete_warning": "Esta acción no se puede deshacer.",
            "cancel": "Cancelar",
            "no_results": "No se encontraron vehículos.",
            "total": "Total",
            "prev": "Anterior",
            "next": "Siguiente",
            "page_of": "Página {page} / {total_pages}",
            "page_size": "{size} / página",
            "form_view_title": "Vehículo",
            "form_edit_title": "Editar vehículo",
            "form_new_title": "Nuevo vehículo",
            "select_office": "Selecciona una oficina",
            "search_office_placeholder": "Buscar oficina...",
            "office_not_found": "Selecciona una oficina válida.",
        },
        "offices": {
            "title": "Oficinas",
            "new_office": "Nueva oficina",
            "search_placeholder": "Buscar oficinas...",
            "name": "Nombre",
            "address": "Dirección",
            "coordinates": "Coordenadas",
            "storage": "Almacenamiento",
            "view": "Ver",
            "edit": "Editar",
            "delete": "Eliminar",
            "delete_title": "Eliminar oficina",
            "delete_question": "¿Seguro que quieres eliminar {name}?",
            "delete_warning": "Esta acción no se puede deshacer.",
            "cancel": "Cancelar",
            "no_results": "No se encontraron oficinas.",
            "total": "Total",
            "prev": "Anterior",
            "next": "Siguiente",
            "page_of": "Página {page} / {total_pages}",
            "page_size": "{size} / página",
            "form_view_title": "Oficina",
            "form_edit_title": "Editar oficina",
            "form_new_title": "Nueva oficina",
            "latitude": "Latitud",
            "longitude": "Longitud",
            "map_location": "Ubicación en mapa",
            "showing_coordinates": "Mostrando coordenadas",
            "storage_capacity": "Capacidad de almacenamiento",
            "name_required": "El nombre es obligatorio",
            "storage_required": "La capacidad de almacenamiento es obligatoria",
        },

        "routes": {
            "title": "Rutas",
            "new_route": "Nueva ruta",
            "search_placeholder": "Buscar rutas...",
            "office": "Oficina",
            "vehicle": "Vehículo",
            "service_date": "Fecha de servicio",
            "status": "Estado",
            "total_tasks": "Total de tareas",
            "total_distance_m": "Distancia total (m)",
            "total_duration_s": "Duración total (s)",
            "total_load": "Carga total",
            "view": "Ver",
            "edit": "Editar",
            "delete": "Eliminar",
            "no_results": "No se encontraron rutas.",
            "total": "Total",
            "prev": "Anterior",
            "next": "Siguiente",
            "page_of": "Página {page} / {total_pages}",
            "page_size": "{size} / página",
            "form_view_title": "Ruta",
            "form_edit_title": "Editar ruta",
            "form_new_title": "Nueva ruta",
            "select_office": "Selecciona una oficina",
            "search_office_placeholder": "Buscar oficina...",
            "office_load_error": "No pudimos cargar oficinas. Intenta nuevamente.",
            "select_vehicle": "Selecciona un vehículo",
            "search_vehicle_placeholder": "Buscar vehículo...",
            "vehicle_load_error": "No pudimos cargar vehículos. Intenta nuevamente.",
            "status_draft": "Borrador",
            "status_planned": "Planificada",
            "status_in_progress": "En progreso",
            "status_completed": "Completada",
            "status_cancelled": "Cancelada",
            "status_failed": "Fallida"
        },

        "route_tasks": {
            "title": "Tareas de ruta",
            "new_route_task": "Nueva tarea de ruta",
            "search_placeholder": "Buscar tareas de ruta...",
            "route_uuid": "Ruta",
            "task_uuid": "Tarea",
            "sequence_order": "Secuencia",
            "status": "Estado",
            "planned_arrival_at": "Llegada planificada",
            "planned_departure_at": "Salida planificada",
            "actual_arrival_at": "Llegada real",
            "actual_departure_at": "Salida real",
            "view": "Ver",
            "edit": "Editar",
            "delete": "Eliminar",
            "no_results": "No se encontraron tareas de ruta.",
            "total": "Total",
            "prev": "Anterior",
            "next": "Siguiente",
            "page_of": "Página {page} / {total_pages}",
            "page_size": "{size} / página",
            "form_view_title": "Tarea de ruta",
            "form_edit_title": "Editar tarea de ruta",
            "form_new_title": "Nueva tarea de ruta",
            "select_route": "Selecciona una ruta",
            "search_route_placeholder": "Buscar ruta...",
            "route_load_error": "No pudimos cargar rutas. Intenta nuevamente.",
            "select_task": "Selecciona una tarea",
            "search_task_placeholder": "Buscar tarea...",
            "task_load_error": "No pudimos cargar tareas. Intenta nuevamente.",
            "status_pending": "Pendiente",
            "status_arrived": "Llegada",
            "status_completed": "Completada",
            "status_skipped": "Omitida",
            "status_failed": "Fallida",
            "integrity_error": "Relación ruta/tarea inválida o secuencia/tarea duplicada en la ruta.",
        },
        "tasks": {
            "title": "Tareas",
            "new_task": "Nueva tarea",
            "search_placeholder": "Buscar tareas...",
            "type": "Tipo",
            "status": "Estado",
            "office": "Oficina",
            "priority": "Prioridad",
            "reference": "Referencia",
            "address": "Dirección",
            "time_window_start": "Inicio de ventana",
            "time_window_end": "Fin de ventana",
            "service_duration_minutes": "Duración de servicio (min)",
            "load_units": "Unidades de carga",
            "notes": "Notas",
            "view": "Ver",
            "edit": "Editar",
            "delete": "Eliminar",
            "delete_title": "Eliminar tarea",
            "delete_question": "¿Seguro que quieres eliminar {name}?",
            "delete_warning": "Esta acción no se puede deshacer.",
            "cancel": "Cancelar",
            "no_results": "No se encontraron tareas.",
            "total": "Total",
            "prev": "Anterior",
            "next": "Siguiente",
            "page_of": "Página {page} / {total_pages}",
            "page_size": "{size} / página",
            "form_view_title": "Tarea",
            "form_edit_title": "Editar tarea",
            "form_new_title": "Nueva tarea",
            "type_pickup": "Recogida",
            "type_delivery": "Entrega",
            "status_pending": "Pendiente",
            "status_scheduled": "Programada",
            "status_in_progress": "En progreso",
            "status_completed": "Completada",
            "status_failed": "Fallida",
            "status_cancelled": "Cancelada",
            "priority_low": "Baja",
            "priority_normal": "Normal",
            "priority_high": "Alta",
            "select_office": "Selecciona una oficina",
            "search_office_placeholder": "Buscar oficina...",
            "office_load_error": "No pudimos cargar oficinas. Intenta nuevamente.",
        },
    },
}


def normalize_locale(lang: str | None) -> str:
    if not lang:
        return DEFAULT_LOCALE
    candidate = lang.strip().lower()
    return candidate if candidate in SUPPORTED_LOCALES else DEFAULT_LOCALE


def translate(locale: str, key: str, **kwargs: object) -> str:
    section, message_key = key.split(".", maxsplit=1)
    messages = TRANSLATIONS.get(locale, TRANSLATIONS[DEFAULT_LOCALE])
    fallback_messages = TRANSLATIONS[DEFAULT_LOCALE]
    message = messages.get(section, {}).get(message_key) or fallback_messages.get(section, {}).get(message_key) or key
    return message.format(**kwargs)


def build_url(path: str, lang: str, **query_params: object) -> str:
    clean = {k: v for k, v in query_params.items() if v is not None and v != ""}
    clean["lang"] = lang
    query = urlencode(clean)
    return f"{path}?{query}" if query else path
